<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Environment Test - Bonfie OpenERP</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        h1 { 
            margin-bottom: 30px;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        .status-card {
            background: rgba(255,255,255,0.15);
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .status-item:last-child {
            border-bottom: none;
        }
        .label {
            font-weight: 600;
        }
        .value {
            font-family: 'Courier New', monospace;
            background: rgba(0,0,0,0.2);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
        }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .warning { color: #fbbf24; }
        .info { color: #60a5fa; }
        button {
            background: rgba(255,255,255,0.2);
            border: 2px solid #fff;
            color: #fff;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        button:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        .test-results {
            margin-top: 20px;
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 5px 0;
            padding: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 5px;
            font-size: 0.9em;
        }
        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid #fff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ ÁîüÁî¢Áí∞Â¢ÉÊ∏¨Ë©¶ - Bonfie OpenERP</h1>
        
        <div class="status-card">
            <h2>Áí∞Â¢ÉË≥áË®ä</h2>
            <div class="status-item">
                <span class="label">Áí∞Â¢ÉÊ®°ÂºèÔºö</span>
                <span class="value" id="env-mode">Ê™¢Ê∏¨‰∏≠...</span>
            </div>
            <div class="status-item">
                <span class="label">Supabase URLÔºö</span>
                <span class="value" id="supabase-url">Ê™¢Ê∏¨‰∏≠...</span>
            </div>
            <div class="status-item">
                <span class="label">Â∞àÊ°à IDÔºö</span>
                <span class="value" id="project-id">Ê™¢Ê∏¨‰∏≠...</span>
            </div>
            <div class="status-item">
                <span class="label">ÈÄ£Êé•ÁãÄÊÖãÔºö</span>
                <span class="value" id="connection-status">Ê™¢Ê∏¨‰∏≠...</span>
            </div>
        </div>

        <div class="status-card">
            <h2>Ê∏¨Ë©¶ÊéßÂà∂</h2>
            <div style="text-align: center;">
                <button onclick="testConnection()">Ê∏¨Ë©¶ Supabase ÈÄ£Êé•</button>
                <button onclick="testDatabase()">Ê∏¨Ë©¶Ë≥áÊñôÂ∫´Êü•Ë©¢</button>
                <button onclick="testAuth()">Ê∏¨Ë©¶Ë™çË≠âÁ≥ªÁµ±</button>
                <button onclick="clearLogs()">Ê∏ÖÈô§Êó•Ë™å</button>
            </div>
        </div>

        <div class="test-results" id="test-results">
            <h3>Ê∏¨Ë©¶ÁµêÊûú</h3>
            <div id="logs"></div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

        // ÁîüÁî¢Áí∞Â¢ÉÈÖçÁΩÆ
        const PROD_SUPABASE_URL = 'https://dgaehncnhomnaxfgvcpo.supabase.co'
        const PROD_SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRnYWVobmNuaG9tbmF4Zmd2Y3BvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyOTI2NDUsImV4cCI6MjA3MTg2ODY0NX0.p1lqClbyUD0sy6SQelzI8iX5eZw4ykT7VDwrEJz4SvQ'

        const supabase = createClient(PROD_SUPABASE_URL, PROD_SUPABASE_ANON_KEY)
        window.supabase = supabase

        // È°ØÁ§∫Áí∞Â¢ÉË≥áË®ä
        document.getElementById('env-mode').textContent = 'Production'
        document.getElementById('env-mode').className = 'value success'
        document.getElementById('supabase-url').textContent = PROD_SUPABASE_URL.replace('https://', '')
        document.getElementById('project-id').textContent = 'dgaehncnhomnaxfgvcpo'

        function log(message, type = 'info') {
            const logs = document.getElementById('logs')
            const logEntry = document.createElement('div')
            logEntry.className = `log-entry ${type}`
            const timestamp = new Date().toLocaleTimeString('zh-TW')
            logEntry.innerHTML = `<span class="${type}">[${timestamp}]</span> ${message}`
            logs.insertBefore(logEntry, logs.firstChild)
            console.log(`[${type}]`, message)
        }

        // Ëá™ÂãïÊ∏¨Ë©¶ÈÄ£Êé•
        async function autoTest() {
            log('ÈñãÂßãËá™ÂãïÊ∏¨Ë©¶ÁîüÁî¢Áí∞Â¢É...', 'info')
            
            try {
                // Ê∏¨Ë©¶Âü∫Êú¨ÈÄ£Êé•
                const healthResponse = await fetch(`${PROD_SUPABASE_URL}/rest/v1/`, {
                    headers: {
                        'apikey': PROD_SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${PROD_SUPABASE_ANON_KEY}`
                    }
                })
                
                if (healthResponse.ok) {
                    document.getElementById('connection-status').textContent = '‚úÖ Â∑≤ÈÄ£Êé•'
                    document.getElementById('connection-status').className = 'value success'
                    log('ÁîüÁî¢Áí∞Â¢É Supabase ÈÄ£Êé•ÊàêÂäüÔºÅ', 'success')
                } else {
                    throw new Error(`ÈÄ£Êé•Â§±Êïó: ${healthResponse.status}`)
                }

                // Áç≤Âèñ Session
                const { data: sessionData, error: sessionError } = await supabase.auth.getSession()
                if (!sessionError) {
                    log(`Ë™çË≠âÁãÄÊÖã: ${sessionData.session ? 'Â∑≤ÁôªÂÖ•' : 'Êú™ÁôªÂÖ•'}`, 'info')
                }

            } catch (error) {
                document.getElementById('connection-status').textContent = '‚ùå ÈÄ£Êé•Â§±Êïó'
                document.getElementById('connection-status').className = 'value error'
                log(`ÈÄ£Êé•ÈåØË™§: ${error.message}`, 'error')
            }
        }

        window.testConnection = async function() {
            log('Ê∏¨Ë©¶ Supabase ÈÄ£Êé•...', 'info')
            
            try {
                // Ê∏¨Ë©¶ REST API
                const response = await fetch(`${PROD_SUPABASE_URL}/rest/v1/`, {
                    headers: {
                        'apikey': PROD_SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${PROD_SUPABASE_ANON_KEY}`
                    }
                })
                
                log(`REST API ÂõûÊáâ: ${response.status} ${response.statusText}`, 
                    response.ok ? 'success' : 'error')

                // Ê∏¨Ë©¶ Auth API
                const authResponse = await fetch(`${PROD_SUPABASE_URL}/auth/v1/health`, {
                    headers: { 'apikey': PROD_SUPABASE_ANON_KEY }
                })
                
                log(`Auth API ÂõûÊáâ: ${authResponse.status}`, 
                    authResponse.ok ? 'success' : 'warning')

            } catch (error) {
                log(`ÈÄ£Êé•Ê∏¨Ë©¶Â§±Êïó: ${error.message}`, 'error')
            }
        }

        window.testDatabase = async function() {
            log('Ê∏¨Ë©¶Ë≥áÊñôÂ∫´Êü•Ë©¢...', 'info')
            
            try {
                // Êü•Ë©¢ roles Ë°®
                const { data: roles, error: rolesError, count } = await supabase
                    .from('roles')
                    .select('*', { count: 'exact' })
                    .limit(5)
                
                if (rolesError) {
                    log(`Roles Êü•Ë©¢ÈåØË™§: ${rolesError.message}`, 'error')
                } else {
                    log(`‚úÖ Roles Ë°®: ÊâæÂà∞ ${count || roles.length} Á≠ÜË®òÈåÑ`, 'success')
                    if (roles && roles.length > 0) {
                        log(`ËßíËâ≤: ${roles.map(r => r.role_name).join(', ')}`, 'info')
                    }
                }

                // Êü•Ë©¢ users Ë°®
                const { data: users, error: usersError } = await supabase
                    .from('users')
                    .select('user_id, username, role_id')
                    .limit(3)
                
                if (usersError) {
                    log(`Users Êü•Ë©¢ÈåØË™§: ${usersError.message}`, 'error')
                } else {
                    log(`‚úÖ Users Ë°®: ÊâæÂà∞ ${users?.length || 0} Á≠Ü‰ΩøÁî®ËÄÖ`, 'success')
                }

                // Êü•Ë©¢ students Ë°®
                const { count: studentCount, error: studentError } = await supabase
                    .from('students')
                    .select('*', { count: 'exact', head: true })
                
                if (studentError) {
                    log(`Students Êü•Ë©¢ÈåØË™§: ${studentError.message}`, 'error')
                } else {
                    log(`‚úÖ Students Ë°®: ÂÖ±Êúâ ${studentCount} ‰ΩçÂ≠∏Áîü`, 'success')
                }

            } catch (error) {
                log(`Ë≥áÊñôÂ∫´Ê∏¨Ë©¶Â§±Êïó: ${error.message}`, 'error')
            }
        }

        window.testAuth = async function() {
            log('Ê∏¨Ë©¶Ë™çË≠âÁ≥ªÁµ±...', 'info')
            
            try {
                const { data: { session }, error } = await supabase.auth.getSession()
                
                if (error) {
                    log(`Ë™çË≠âÈåØË™§: ${error.message}`, 'error')
                    return
                }

                if (session) {
                    log('‚úÖ Â∑≤ÁôªÂÖ•', 'success')
                    log(`Áî®Êà∂ Email: ${session.user.email}`, 'info')
                    log(`Áî®Êà∂ ID: ${session.user.id}`, 'info')
                    log(`Session ÈÅéÊúüÊôÇÈñì: ${new Date(session.expires_at * 1000).toLocaleString('zh-TW')}`, 'info')
                } else {
                    log('‚ö†Ô∏è Êú™ÁôªÂÖ•', 'warning')
                    log('ÊèêÁ§∫: Ë´ã‰ΩøÁî®ÁîüÁî¢Áí∞Â¢ÉÁöÑÂ∏≥ËôüÁôªÂÖ•', 'info')
                }

                // Áõ£ËÅΩË™çË≠âÁãÄÊÖãËÆäÂåñ
                supabase.auth.onAuthStateChange((event, session) => {
                    log(`Ë™çË≠â‰∫ã‰ª∂: ${event}`, 'info')
                    if (session) {
                        log(`Session Êõ¥Êñ∞: ${session.user.email}`, 'success')
                    }
                })

            } catch (error) {
                log(`Ë™çË≠âÊ∏¨Ë©¶Â§±Êïó: ${error.message}`, 'error')
            }
        }

        window.clearLogs = function() {
            document.getElementById('logs').innerHTML = ''
            log('Êó•Ë™åÂ∑≤Ê∏ÖÈô§', 'info')
        }

        // È†ÅÈù¢ËºâÂÖ•ÊôÇËá™ÂãïÊ∏¨Ë©¶
        autoTest()
    </script>
</body>
</html>